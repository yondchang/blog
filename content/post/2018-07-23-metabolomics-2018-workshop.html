---
title: metabolomics 2018 workshop
author: Dabao Zhang and Min Zhang
date: '2018-07-23'
slug: metabolomics-2018-workshop
categories: []
tags: []
---



<p>This tutorial is based on workshop by Min Zhang and Dabao Zhang <a href="http://www.stat.purdue.edu/~zhangdb/packages/POCRE/" class="uri">http://www.stat.purdue.edu/~zhangdb/packages/POCRE/</a></p>
<pre class="r"><code>mbd &lt;- read.table(&quot;metabdata.csv&quot;,header=T,sep=&quot;,&quot;)
head(mbd)</code></pre>
<pre><code>##   Diagnosis Age Gender   BMI Smoking Alcohol   Formate Histidine
## 1    Polyps  48      M 22.00     Yes      No 10.284198  81.25795
## 2    Polyps  50      M 32.80      No      No  2.190488 103.05184
## 3    Polyps  53      F 23.34      No     Yes 12.954623 116.95868
## 4    Polyps  53      F 22.30      No      No  4.533463 130.20090
## 5    Polyps  55      M 24.50      No     Yes  8.096929 111.95904
## 6    Polyps  55      M 33.00      No      No 12.643753 126.33281
##   Phenylalanine Tyrosine     Urea Unsaturate.Lipids  Glucose Threonine
## 1     111.82057 45.32021 191.5806         3080.7249 1325.424  518.3257
## 2      70.78241 54.61597 158.7471         2192.0944 1704.053  607.3693
## 3     163.78317 76.53537 439.7202          897.4816 1671.825  736.6308
## 4      79.01733 71.10152 180.9137         1875.8008 2026.435  501.9727
## 5      84.10746 62.95125 139.3122         2728.4029 1472.222  519.5280
## 6     115.73892 83.09715 129.1230         1888.7315 1707.031  612.6526
##    Lactate Creatinine  Glycine Choline.Phosphocholine   Lysine
## 1 418.0202  110.79484 292.4338               2433.559 374.0597
## 2 484.4745  149.00986 323.3713               2144.385 482.3460
## 3 931.0390  124.05885 471.2856               3174.940 611.6825
## 4 503.2655   95.84867 264.4822               3497.352 535.6388
## 5 575.0472  153.00957 314.2641               2839.626 465.1237
## 6 624.3059  155.83042 316.4153               3030.071 640.0113
##   Dimethylglycine Citric.acid Glutamine Glutamic.acid Acetoacetate
## 1        42.24443    123.4214  634.7745      326.1336     145.7854
## 2        75.73314    257.9447 1121.1010      413.1681     171.1169
## 3        73.63420    497.2508 1412.2490      585.6655     750.3555
## 4        60.47198    256.6172 1200.9581      389.8260     216.4923
## 5        65.03387    199.5429 1063.3462      403.2163     143.0917
## 6        88.10509    267.0590 1211.0202      501.5705     217.2506
##     Acetone Acetic.acid   Alanine X3.hydroxybutyric.acid   Valine
## 1  482.1625    124.3118  923.0275               740.3038 460.9621
## 2  295.4363    142.1678 1557.6425               481.9264 606.9665
## 3 1487.6887    210.6812 1485.7262              2965.0379 857.1573
## 4  468.2177    134.4554 1224.6017               917.6038 549.1478
## 5  385.7700    142.1869 1303.4498               677.2214 624.1898
## 6  708.4203    204.1675 1494.2345               886.1662 688.2485
##   Isoleucine
## 1   110.2875
## 2   133.7548
## 3   205.8861
## 4   119.8784
## 5   129.7284
## 6   141.0204</code></pre>
<pre class="r"><code>plot(nspca &lt;- prcomp(mbd[,7:30], scale. = F))</code></pre>
<p><img src="/post/2018-07-23-metabolomics-2018-workshop_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>plot(scpca &lt;- prcomp(mbd[,7:30], scale. = T))</code></pre>
<p><img src="/post/2018-07-23-metabolomics-2018-workshop_files/figure-html/unnamed-chunk-2-2.png" width="672" /></p>
<pre class="r"><code>summary(nspca)</code></pre>
<pre><code>## Importance of components%s:
##                              PC1      PC2       PC3       PC4       PC5
## Standard deviation     1065.3469 457.9826 382.90640 222.07932 152.25772
## Proportion of Variance    0.6993   0.1292   0.09033   0.03039   0.01428
## Cumulative Proportion     0.6993   0.8285   0.91884   0.94922   0.96351
##                             PC6       PC7     PC8      PC9     PC10
## Standard deviation     125.4712 107.15810 91.8809 78.44530 65.92114
## Proportion of Variance   0.0097   0.00707  0.0052  0.00379  0.00268
## Cumulative Proportion    0.9732   0.98028  0.9855  0.98927  0.99195
##                            PC11     PC12     PC13     PC14    PC15
## Standard deviation     59.37011 56.58234 39.11030 37.23575 31.2844
## Proportion of Variance  0.00217  0.00197  0.00094  0.00085  0.0006
## Cumulative Proportion   0.99412  0.99610  0.99704  0.99789  0.9985
##                            PC16     PC17    PC18     PC19    PC20    PC21
## Standard deviation     28.91335 24.39339 22.2082 15.81130 9.90304 8.74750
## Proportion of Variance  0.00052  0.00037  0.0003  0.00015 0.00006 0.00005
## Cumulative Proportion   0.99901  0.99938  0.9997  0.99983 0.99990 0.99994
##                           PC22    PC23  PC24
## Standard deviation     7.40003 5.58324 2.754
## Proportion of Variance 0.00003 0.00002 0.000
## Cumulative Proportion  0.99998 1.00000 1.000</code></pre>
<pre class="r"><code>summary(scpca)</code></pre>
<pre><code>## Importance of components%s:
##                           PC1    PC2     PC3     PC4     PC5     PC6
## Standard deviation     3.2686 1.6868 1.29606 1.25153 1.19283 0.99726
## Proportion of Variance 0.4451 0.1186 0.06999 0.06526 0.05929 0.04144
## Cumulative Proportion  0.4451 0.5637 0.63368 0.69895 0.75823 0.79967
##                            PC7     PC8     PC9    PC10    PC11    PC12
## Standard deviation     0.91973 0.84353 0.79821 0.65413 0.60099 0.58972
## Proportion of Variance 0.03525 0.02965 0.02655 0.01783 0.01505 0.01449
## Cumulative Proportion  0.83492 0.86457 0.89111 0.90894 0.92399 0.93848
##                           PC13    PC14    PC15    PC16    PC17    PC18
## Standard deviation     0.52679 0.46454 0.43993 0.39572 0.38063 0.36281
## Proportion of Variance 0.01156 0.00899 0.00806 0.00652 0.00604 0.00548
## Cumulative Proportion  0.95004 0.95904 0.96710 0.97363 0.97966 0.98515
##                           PC19    PC20    PC21    PC22   PC23    PC24
## Standard deviation     0.30514 0.29954 0.27911 0.20862 0.2019 0.10699
## Proportion of Variance 0.00388 0.00374 0.00325 0.00181 0.0017 0.00048
## Cumulative Proportion  0.98903 0.99277 0.99601 0.99782 0.9995 1.00000</code></pre>
<pre><code>## Warning: package &#39;pls&#39; was built under R version 3.4.4</code></pre>
<pre class="r"><code>idiag &lt;- as.integer(mbd$Diagnosis) # 1~Healthy, 2~Polyps
# PCR ignore correlation between principle components and response variable
lmpcr &lt;- pcr(idiag~as.matrix(mbd[,7:30]), ncomp = 5, scale=T)
summary(lmpcr)</code></pre>
<pre><code>## Data:    X dimension: 102 24 
##  Y dimension: 102 1
## Fit method: svdpc
## Number of components considered: 5
## TRAINING: % variance explained
##        1 comps  2 comps  3 comps  4 comps  5 comps
## X        44.51   56.369   63.368   69.895   75.823
## idiag     1.62    2.177    2.195    2.353    2.453</code></pre>
<pre class="r"><code># PLS find principle components that are most correlated to response variable
plsres &lt;- plsr(idiag~as.matrix(mbd[,7:30]), ncomp = 5, scale=T)
summary(plsres)</code></pre>
<pre><code>## Data:    X dimension: 102 24 
##  Y dimension: 102 1
## Fit method: kernelpls
## Number of components considered: 5
## TRAINING: % variance explained
##        1 comps  2 comps  3 comps  4 comps  5 comps
## X       43.273   52.666    58.69    62.99    66.68
## idiag    2.802    7.867    13.07    16.08    17.75</code></pre>
<pre class="r"><code># PCR allow response to be multiple variables
dbpres &lt;- pcr(as.matrix(mbd[,c(2, 12)])~as.matrix(mbd[,7:11]) + as.matrix(mbd[,13:30]),5)
summary(dbpres)</code></pre>
<pre><code>## Data:    X dimension: 102 23 
##  Y dimension: 102 2
## Fit method: svdpc
## Number of components considered: 5
## TRAINING: % variance explained
##                    1 comps  2 comps  3 comps  4 comps  5 comps
## X                  64.2397   78.670   88.158   92.783   94.659
## Age                 0.1632    2.333    2.335    3.551    4.446
## Unsaturate.Lipids  62.1698   62.196   91.939   93.629   95.438</code></pre>
<pre class="r"><code># SUR allow each trait to have its unique linear model
require(systemfit,warn.conflicts=F,quietly=T)</code></pre>
<pre><code>## Warning: package &#39;systemfit&#39; was built under R version 3.4.4</code></pre>
<pre><code>## 
## Attaching package: &#39;zoo&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     as.Date, as.Date.numeric</code></pre>
<pre><code>## 
## Please cite the &#39;systemfit&#39; package as:
## Arne Henningsen and Jeff D. Hamann (2007). systemfit: A Package for Estimating Systems of Simultaneous Equations in R. Journal of Statistical Software 23(4), 1-40. http://www.jstatsoft.org/v23/i04/.
## 
## If you have questions, suggestions, or comments regarding the &#39;systemfit&#39; package, please use a forum or &#39;tracker&#39; at systemfit&#39;s R-Forge site:
## https://r-forge.r-project.org/projects/systemfit/</code></pre>
<pre class="r"><code>mbd$idiag &lt;- as.integer(mbd$Diagnosis)
mbd$igender &lt;- as.integer(mbd$Gender)
mbd$ismoke &lt;- as.integer(mbd$Smoking)
mbd$ialco &lt;- as.integer(mbd$Alcohol)
eqAcetoac &lt;- Acetoacetate~Age+BMI+idiag+igender+ismoke+ialco
eqX3 &lt;- X3.hydroxybutyric.acid~Age+BMI+idiag+igender+ismoke+ialco
system &lt;- list(Acetoac=eqAcetoac,X3=eqX3)
sres &lt;- systemfit(system, method=&quot;SUR&quot;,data=mbd)
summary(sres)</code></pre>
<pre><code>## 
## systemfit results 
## method: SUR 
## 
##          N  DF      SSR   detRCov   OLS-R2 McElroy-R2
## system 204 190 11482707 173336955 0.092359   0.074933
## 
##           N DF      SSR       MSE     RMSE       R2   Adj R2
## Acetoac 102 95   651239   6855.14  82.7958 0.082152 0.024182
## X3      102 95 10831468 114015.45 337.6617 0.092965 0.035679
## 
## The covariance matrix of the residuals used for estimation
##          Acetoac       X3
## Acetoac  6855.14  24662.8
## X3      24662.83 114015.5
## 
## The covariance matrix of the residuals
##          Acetoac       X3
## Acetoac  6855.14  24662.8
## X3      24662.83 114015.5
## 
## The correlations of the residuals
##          Acetoac       X3
## Acetoac 1.000000 0.882171
## X3      0.882171 1.000000
## 
## 
## SUR estimates for &#39;Acetoac&#39; (equation 1)
## Model Formula: Acetoacetate ~ Age + BMI + idiag + igender + ismoke + ialco
## 
##               Estimate Std. Error  t value   Pr(&gt;|t|)    
## (Intercept) 354.296933  90.578853  3.91148 0.00017222 ***
## Age          -1.801825   1.313164 -1.37213 0.17325584    
## BMI          -2.580411   1.395189 -1.84951 0.06749389 .  
## idiag         5.934606  17.519627  0.33874 0.73555286    
## igender     -12.877655  17.167888 -0.75010 0.45504743    
## ismoke        0.652716  17.356886  0.03761 0.97008108    
## ialco        26.635232  18.345641  1.45186 0.14983620    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 82.795788 on 95 degrees of freedom
## Number of observations: 102 Degrees of Freedom: 95 
## SSR: 651238.530687 MSE: 6855.142428 Root MSE: 82.795788 
## Multiple R-Squared: 0.082152 Adjusted R-Squared: 0.024182 
## 
## 
## SUR estimates for &#39;X3&#39; (equation 2)
## Model Formula: X3.hydroxybutyric.acid ~ Age + BMI + idiag + igender + ismoke + 
##     ialco
## 
##               Estimate Std. Error  t value   Pr(&gt;|t|)    
## (Intercept) 1577.23589  369.40301  4.26969 4.6379e-05 ***
## Age           -6.89262    5.35541 -1.28704   0.201207    
## BMI          -12.82666    5.68993 -2.25427   0.026477 *  
## idiag         48.66157   71.44938  0.68106   0.497488    
## igender      -91.95326   70.01490 -1.31334   0.192232    
## ismoke       -28.49348   70.78568 -0.40253   0.688197    
## ialco         51.50946   74.81807  0.68846   0.492839    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 337.661743 on 95 degrees of freedom
## Number of observations: 102 Degrees of Freedom: 95 
## SSR: 10831468.010355 MSE: 114015.452741 Root MSE: 337.661743 
## Multiple R-Squared: 0.092965 Adjusted R-Squared: 0.035679</code></pre>
<pre class="r"><code>coefficients(summary(sres))</code></pre>
<pre><code>##                         Estimate Std. Error     t value     Pr(&gt;|t|)
## Acetoac_(Intercept)  354.2969326  90.578853  3.91147516 1.722212e-04
## Acetoac_Age           -1.8018247   1.313164 -1.37212509 1.732558e-01
## Acetoac_BMI           -2.5804107   1.395189 -1.84950625 6.749389e-02
## Acetoac_idiag          5.9346055  17.519627  0.33874041 7.355529e-01
## Acetoac_igender      -12.8776547  17.167888 -0.75010127 4.550474e-01
## Acetoac_ismoke         0.6527157  17.356886  0.03760557 9.700811e-01
## Acetoac_ialco         26.6352316  18.345641  1.45185616 1.498362e-01
## X3_(Intercept)      1577.2358868 369.403012  4.26968875 4.637911e-05
## X3_Age                -6.8926237   5.355406 -1.28704025 2.012074e-01
## X3_BMI               -12.8266555   5.689926 -2.25427439 2.647657e-02
## X3_idiag              48.6615663  71.449381  0.68106352 4.974881e-01
## X3_igender           -91.9532559  70.014904 -1.31333832 1.922322e-01
## X3_ismoke            -28.4934840  70.785685 -0.40253173 6.881971e-01
## X3_ialco              51.5094591  74.818070  0.68846281 4.928392e-01</code></pre>
<pre class="r"><code># POCRE helps to screen important variables before fitting a model
library(POCRE)
data(simdata)
yy &lt;- simdata[1:50,1]
xx &lt;- as.matrix(simdata[1:50,2:1001])
xxs &lt;- as.matrix(xx[,1:200])
axpls &lt;- plsr(yy~xx,5) # Using all x
sxpls &lt;- plsr(yy~xxs,5) # Using selected x
xxn &lt;- simdata[51:100,2:1001] # new x
xxsn &lt;- as.matrix(xxn[,1:200]) # new x
ya &lt;- predict(axpls,xxn)
ys &lt;- predict(sxpls,xxsn)
sum((simdata[51:100,1]-ya[,,5])^2) #prediction error when using
sum((simdata[51:100,1]-ys[,,5])^2) #prediction error when using

xx &lt;- scale(as.matrix(simdata[,-1]))
yy &lt;- scale(as.matrix(simdata[,1]))
psres &lt;- pocrescreen(yy,xx,maxvar=50,maxcmp=10)
psX &lt;- psres$retX
psXIdx &lt;- psres$retSIdx
rbind(psXIdx[1:10],psXIdx[11:20])

tres &lt;- pocre(yy,xx)$retRes # inTP=1 by default
ppres &lt;- pocrepath(yy,xx,delta=0.01) # Scan tuning parameter
optres &lt;- selectmodel(inRes=ppres)</code></pre>
